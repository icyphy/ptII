<!--$Id$ -->
<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<link href="../default.css" rel="stylesheet" type="text/css">
<title>Release Management</title>
</head>
<body>
<h1>Release Management</h1>
This page describes how we release software.
 <p>The following pages might be of use:
<menu>
<li> <a href="develsetup.htm" target="main">Development Tree</A>
<li> <a href="testing.htm" target="main">Testing</A>
</menu>

<h2><a name="Building a release">Building a release</a></h2>


<h2>Splitting the tree</h2>
<ol>
<li>Add any new models to <code>$PTII/ptolemy/configs/doc/completeDemos.htm</code>

<li>If necessary create applets for new demos
<pre>
cd $PTII/ptolemy/domains/wireless/demo/SmartParking
$PTII/bin/copernicus -codeGenerator applet -targetPath ptolemy/domains/wireless/demo/SmartParking SmartParking.xml
</pre>
Then add the <code>.htm</code> files to the makefile.
<br>Note that sometimes we use just the Vergil applet, in which case
we do
<pre>
mv <i>Foo</i>VergilApplet.htm <i>Foo</i>Applet.htm
</pre>

<li> Ptolemy handled 
<a href="about:copyright"><code>about:copyright</code></a>
URLS specially.  One facility on the copyrigth page is the ability
to expand all the model, .html files and .pdf files on 
the various demonstration pages.  This allows us to
verify that all the resources are present in the tree.
<br>Following the links on 
<a href="about:copyright"><code>about:copyright</code></a>
is an essential part of testing each release.

<br>For details, see
<a href="../codeDoc/ptolemy/actor/gui/GenerateCopyrights.html">actor.gui.GenerateCopyrights</a>
and
<a href="../codeDoc/ptolemy/actor/gui/HTMLViewer.html">actor.gui.HTMLViewer</a>


<li> Ptolemy II is organized in to jar files, where each
directory contains a jar file of the .class files and another
resources that are necessary for that package.  These resources
include files like images and pdfs.  Parent directories contain
the jar files in children directories.  
<br>When building a release, it is usually best to build
the Web Start release first because it is easier to change
one jar file and retry something in
<a href="../webStartHelp.htm">Web Start</a> than it is to 
rebuild an entire Windows installer.
<br>Use
<a href="about:copyright"><code>about:copyright</code></a>
to test the Web Start release.

<li> Clean the tree by running <CODE>make checkjunk</CODE>
and adding files as appropriate to the makefiles

<li> Run <a href="../../util/testsuite/chkjava"><CODE>$PTII/util/testsuite/chkjava</CODE></a> on the java files and fix problems

<li> Run Jalopy to add curly brackets around single statement if,
while and other statements:

<br>Wrong:
<pre>
if (foo == bar) 
    return; 
</pre>

Right:
<pre>
if (foo == bar) {
    return; 
}
</pre>

The reason this is important is because if one does
<pre>
if (foo == bar) 
    System.out.println("About to return");
    return; 
</pre>
then the return is not part of the if statement.

<p>We indent using Jalopy to add braces and then reindent using
jindent to get the indentation right. 
<p>
To set up Jalopy: 
 <ol>
 <li> Download the console version from
<a href="http://jalopy.sourceforge.net/download.html"><code>http://jalopy.sourceforge.net/download.html</code></a>

 <li> Create a directory to unzip the download into and unzip it.
 <br>Note: the zip file will create directories like
 <code>bin</code>, <code>docs</code> and <code>lib</code> in the current
 directory, so be sure to unzip it inside an empty directory.
 <br> See also <a href="http://jalopy.sourceforge.net/plugin-console.html"><code>http://jalopy.sourceforge.net/plugin-console.html</code></a>
 
 <li> Run <code>bin/preferences.sh</code>
   <br>If you get
   <pre>
c:/Program: not found
   </pre>
   You may need to edit <code>bin/preferences.sh</code> and put double
   quotes around <code>JAVACMD</code> in the last line:
   <pre>
"$JAVACMD" -classpath "$LOCALCLASSPATH" de.hunsicker.jalopy.swing.SettingsDialog
   </pre>
 <li> Note that under Windows, the settings are stored in
   <code>c:/Documents and Settings/<i>username</i>/.jalopy
   <br>If things get confusing, you may want to remove that directory
   and start <code>bin/preferences.sh</code> over again
 <li> In the "Jalopy Settings" window, under Printer -&gt; Braces
   -&gt Misc, click all the boxes in the Insert braces section
 <li> Change the continuation indent to 8 characters:
   under Indentation -&gt; Sizes, change the continuation indent to
   8 characters.
 <li> Disable sorting: under Printer -&gt; Sorting -&gt; Declarations,
   uncheck "Sort class elements"
   <br>If sorting is not disabled, then the fields will be before the methods
 <li> Change the wrapping so we wrap before operators:
   under Printer -&gt; Wrapping, in the Policy section, select
   "Wrap before operators".  Also, note that the line length should be
   80 characters so that when we print out the software for review,
   the lines print properly.
 <li>Close the Jalopy Settings window, you are now ready to indent.

 </ol>


<br>Create a list of java files with:
<pre>
# Check out a clean tree
# Make sure empty directories are removed
cvs update -P -d
# Run configure
cd $PTII
./configure
# Remove files created by JavaCC 
cd $PTIIptolemy/data/expr
rm `make echo_OPTIONAL_JSRCS`
cd $PTII/ptolemy/data/unit
rm `make echo_OPTIONAL_JSRCS`
cd $PTII/ptolemy/copernicus/kernel/fragment
rm `make echo_OPTIONAL_JSRCS`
# Create a file that contains the names of the java files to include
cd $PTII
rm -rf vendors apps
rm -rf ptolemy/domains/ct/demo/corba/util/*.java
adm/bin/ptIItxtfiles > /tmp/f
egrep '*.java$' /tmp/f | grep -v /vendors/ >& /tmp/j
</pre>

Run jalopy on the directory that has the pared down ptII tree:
<pre>
cd <i>path_to_jalopy</i>
bin/jalopy.sh -r $PTII
</pre>

<li> Add trailing newlines to files with
<code>$PTII/adm/bin/addtrailingnl</code>
<pre>
cd $PTII
# Run addtrailingnl without actually doing anything:
cat /tmp/j | xargs $PTII/adm/bin/addtrailingnl -n
# Run addtrailingnl with adding the new lines:
cat /tmp/j | xargs $PTII/adm/bin/addtrailingnl
# Run with -n and then without:
cat /tmp/f | egrep '*.[ch]$' | xargs $PTII/adm/bin/addtrailingnl -n
cat /tmp/f | egrep README | xargs $PTII/adm/bin/addtrailingnl -n
cat /tmp/f | egrep '*.htm' | xargs $PTII/adm/bin/addtrailingnl -n
cat /tmp/f | egrep '*.tcl' | xargs $PTII/adm/bin/addtrailingnl -n
cat /tmp/f | egrep '*.xml' | xargs $PTII/adm/bin/addtrailingnl -n
</pre>
<li> On a Unix box, check for files with control-Ms:
<pre>
cat /tmp/f | xargs $PTII/util/testsuite/controlm
</pre>
Use dos2unix to fix the files.

 <br>Note many of the files in
<CODE>ptolemy/copernicus/c/test/</CODE>
<B>should</B> have a control-M in them, so don't remove them.

<br>Also, check that text files that have control-ms are not
checked in to cvs with -kb:
<pre>
cat /tmp/f | xargs cvs status >& /tmp/cv.out
</pre>
Then search /tmp/cv.out for <code>-kb</code>


<li> Run <a href="../../util/testsuite/jindent"><CODE>$PTII/util/testsuite/jindent</CODE></a> on the java files and indent the files to the Ptolemy II
coding standard.
<blockquote>
When you run jindent, watch out for files that have the entire
class body indented.  If the class comment contains the word
"extends" or "implements" then emacs sometimes indents the 
"public class" and the rest of the body.  Search the output
for "public class" and carefully examine any files where public class
has leading spaces. 
</blockquote>


<li> Run <CODE>$PTII/adm/copyright/fixcopyrights</CODE> (not shipped with
the release) and update the copyrights on the <CODE>.java</CODE>, <CODE>.tcl</CODE> and makefiles

<li> Run <CODE>$PTII/adm/copyright/fixsince</CODE> (not shipped with
the release) and update the @since tags

<li> Run the nightly build, build a release and run
<CODE>$PTII/adm/copyright/chkcopyright</CODE> on all the files.

<pre>
find . -type f -print &gt; ~/tmp/ff
sh ~ptII/adm/copyright/chkcopyright `cat ~/tmp/ff | grep -v .class | grep -v codeDoc | grep -v xml | grep -v alljtests.tcl | grep -v .htm | grep -v qcf | grep -v .dtd | grep -v gif`
</pre>

<li> Concatenate all the javadoc files in to one file and run
<code>$PTII/util/testsuite/ptspell</code>. 

<li> Use Eclipse to fix the imports of the entire tree.


<li> Consider fixing other Eclipse warnings.


<li> Consider using 
<a href="http://gcc.gnu.org/java/">GCJ: The GNU Compiler for Java</a>
to report unused variables and other problems.  Note
that GCJ3.4 will fail to compile awt and swing classes, but
it is still worth getting the other error messages.
<BLOCKQUOTE>
cd $PTII
make clean
make -k JAVAC=gcj34 JFLAGS="-O2 -Wunused -Wextraneous-semicolon -Wno-deprecated -C" all &gt;&amp; make.out &amp;

</BLOCKQUOTE>

<li> Currently, we use 
<a href="http://www.zerog.com" target="_top">Zerog's InstallAnywhere</a>
to build Windows installers.  Building the Windows installer is fairly complex,
below are some things to be aware of
  <menu>
  <li> The Windows installer includes source files.  These sources
  come from $PTII/adm/gen-<i>N.M</i>/ptII<i>N.M</i>.src.jar.  Obviously,
  this jar file should be created on a Windows machine so the end
  of line characters are Windows end of line characters.
  </menu>

<li> Tag the tree as the release tree and create a branch
For more information about CVS, see the
<a href="http://www.gigascale.org/softdevel/faq/1/" target="_top">Gigascale CVS Pages</a>

 <p>To make a branch for 5.1-devel, use the following command:
<pre>
cd $PTII
cvs tag -b rel-5.1-devel
</pre>
Then check out the release branch  with
<pre>
cd ~/src
cvs co -r rel-5.1-devel ptII
mv ptII ptII5.1-devel
</pre>

<li> Update the version numbers, see
<code>$PTII/makefile</code> and <code>$PTII/ptolemy/plot/makefile</code>.

<li> The nightly build uses a makefile in ~ptII/adm (not shipped)
to build the release.  Copy the most recent makefile and
set up a new tree for the release tree.


<li> We build a separate src.tar.gz file under Unix so that the line
endings are correct. 
<pre>
cvs co -r rel-5.1-devel ptII
mv ptII ptII5.1-devel
cd ptII5.1-devel
setenv PTII `pwd`
cd $PTII/adm/gen-5.1
make USER=cxh PTIIHOME=/tmp/ptII5.1-devel PTIIADM=/tmp/ptII5.1-devel/adm TAR=/usr/sfw/bin/gtar JAR=/bin/jar clean all >& make.out &
</pre>
The resulting file with the .class files gets copied to the website
and untar'd.
<pre>
make USER=cxh PTIIHOME=/tmp/ptII5.1-devel PTIIADM=/tmp/ptII5.1-devel/adm TAR=/usr/sfw/bin/gtar JAR=/bin/jar update_ftp
</pre>
<ol>
<li> Fix the links to ptplot downloads:
<pre>
cd /export/home/pt0/ptweb/ptolemyII/ptII5.0/ptII5.0.1/ptolemy/plot
ln -s ../../../../../java/ptplot5.5/ptolemy/plot/ptplot5.5* .
cd doc
rm -rf download
ln -s ../../../../../../java/ptplot5.5-beta/ptolemy/plot/doc/download .
</pre>

<li> Copy gr.jar from a Windows box to <CODE>ptolemy/domains/gr</CODE>

<li> Copy codeDoc.jar from a Windows box and unjar it
</ol>


<li> We build the webstart jar files under Windows
<pre>
cvs co -r rel-5.1-devel ptII
mv ptII ptII5.1-devel
cd ptII5.1-devel
export PTII=c:/src/ptII5.1-devel
./configure
<I>Set up missing packages such as joystick, JAI, JMF, javacomm, quicktime</I>
./configure
make fast

<I>Copy <CODE>~ptII/adm/certs/ptkeystore</CODE> to $PTII.  Note you will
need access to the ptII account on bennett </I>
make jnlp_dist STOREPASSWORD="-storepass xxx" KEYPASSWORD="-keypass xxx"
</pre>
<I>xxx</I> is the ptkeystore password.

<li> Create the src.jar file: 
<pre>
cd $PTII/adm/gen-5.1
make USER=cxh PTIIHOME=/cygdrive/c/cxh/ptII5.1-devel COMPRESS=gzip TAR=tar clean all src.jar 
</pre>


<li> Run InstallAnywhere and create the installer

<li> <a href="testing.htm#installer">Test the installer</a>
</ol>


<p><font size="2" color="#cc0000">Last Updated: $Date$</font>
</body>
</html>
