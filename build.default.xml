<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- $Id$
     $PTII/configure reads in build.xml.in and creates build.xml.
     If configure is not available, copy build.xml.default to build.xml. -->
<project basedir="." default="build" name="ptII">

  <!-- We can refer to any environment variable FOO as ${env.FOO} -->
  <property environment="env" />


  <!-- Ant properties. Alphabetize, please -->

  <!-- checkstyle.formatter defaults to xml and is used by checkstyle and test.  Try also -Dcheckstyle.formater=html. -->
  <property name="checkstyle.formatter" value="xml" />

  <!-- The location of the Cobertura directory, used for code coverage -->
  <property name="cobertura.dir" value="@COBERTURA_DIR@" />

  <property name="debuglevel" value="source,lines,vars" />

  <!-- Location of findbugs, which does static analysis on the code.
       With findbugs-3.0.0, we use a patched version of findbugs that
       supports the -nested:false command line argument, see
       https://sourceforge.net/p/findbugs/feature-requests/295/
    -->
  <property name="findbugs.home" value="${basedir}/vendors/findbugs-3.0.1" />

  <!-- The value of the memorymaximumsize javac and maxmemorysize and java parameter 
       We use 1400m so that we don't have problems under 32-bit
       Windows.  See
       http://javarevisited.blogspot.jp/2013/04/what-is-maximum-heap-size-for-32-bit-64-JVM-Java-memory.html-->
  <property name="java.maxmemory" value="1400m" />

  <!-- The value of the maxmemorysize and java parameter for tests
       that consume a lot of memory.  This will probably not work
       under 32-bit Windows.  See
       http://javarevisited.blogspot.jp/2013/04/what-is-maximum-heap-size-for-32-bit-64-JVM-Java-memory.html-->
  <property name="java.maxmemory.large" value="3500m" />

  <!-- Packages to exclude from targets that call javadoc.
       Unfortunately, <fileset> results in a command line that is too long.
       Grab the packages from ptII.excludes, put them in a file called /tmp/e and run
       awk -F '"' '{print $2}' /tmp/e | sed 's@/$@@' | sed 's@/@.@g' | sort | awk '{printf("%s.*,", $1)}'
       (Lame) -->
  <property name="javadoc.excludepackagenames" value="diva.util.java2d.svg,org.ptolemy.fmi,org.terraswarm.gdp,ptolemy.actor.corba,ptolemy.actor.lib.embeddedJava,ptolemy.actor.lib.excel,ptolemy.actor.lib.fmi,ptolemy.actor.lib.io.comm,ptolemy.actor.lib.jai,ptolemy.actor.lib.jmf,ptolemy.actor.lib.jni,ptolemy.actor.lib.jopio,ptolemy.actor.lib.joystick,ptolemy.actor.lib.jxta,ptolemy.actor.lib.jxta.*,ptolemy.actor.lib.mail,ptolemy.actor.lib.opencv,ptolemy.actor.lib.opencv.*,ptolemy.actor.lib.reactable,ptolemy.actor.lib.vertx,ptolemy.actor.lib.x10,ptolemy.actor.lib.xslt,ptolemy.actor.ptalon,ptolemy.apps.*,ptolemy.backtrack.eclipse.*,ptolemy.backtrack.test,ptolemy.calltrop,ptolemy.chic,ptolemy.copernicus,ptolemy.copernicus.kernel.fragment,ptolemy.distributed,ptolemy.domains.giotto,ptolemy.domains.gr,ptolemy.domains.gr.lib.experimental,ptolemy.domains.gr.lib.quicktime,ptolemy.domains.metroII.kernel,ptolemy.domains.metroII.kernel.util.ProtoBuf,ptolemy.domains.openmodelica.kernel,ptolemy.domains.openmodelica.lib,ptolemy.domains.pdf,ptolemy.domains.ptinyos.demo.Surge.output,ptolemy.domains.space,ptolemy.matlab,ptolemy.moml.jxta,ptolemy.plot.servlet,ptolemy.vergil.basic.export.html,ptolemy.vergil.basic.export.itextpdf,ptolemy.vergil.basic.imprt.g4ltl,ptserver.*,reports.*,src.*,target.*,thales.*,tmp.*,vendors.*" />

  <!-- Packages on which doccheck, javadoc and ojdcheck are run. -->
  <property name="javadoc.packagenames" value="diva.*,lbnl.*,org.hlacerti.*,org.ptolemy.*,org.terraswarm.*,ptolemy.*,ptserver.*" />

  <!-- The location of the jsdoc distribution, used by the jsdoc target. -->
  <property name="jsdoc.home" value="vendors/jsdoc" />

  <!-- junit.formatter defaults to xml and is used by checkstyle and test.  Other values: brief, failure, plain -->
  <property name="junit.formatter" value="xml" />

  <!-- junit.single.formatter defaults to plain and is used by test.single.  Other values: brief, failure, plain -->
  <property name="junit.single.formatter" value="plain" />

  <!-- ptII.reports contains reports generated by checkstyle, findbugs and test.
       ptII.reports must be declared before any properties that refer to it. (Lame).
    -->
  <property name="ptII.reports" value="${basedir}/reports" />

  <!-- The output director for junit. -->
  <property name="junit.output.dir" value="${ptII.reports}/junit" />

  <!-- The location of the file that contains the certificates used to sign JNLP files.
       See $PTII/mk/jnlp.mk for details -->
  <property name="keystore" value="ptKeystore"/>

  <!-- model names the model to be opened.  The default is the empty string.  To use this, run 'ant vergil -Dmodel=foo.xml' -->
  <property name="model" value="" />

  <property name="source" value="1.8" />

  <property name="target" value="1.8" />

  <!-- The pathname of the tests that are run by the test.cobertura, test.report, test.short targets. -->
  <property name="test.batch" value="**/junit/*.java" />

  <!-- The classname of the single JUnit test that is run by the test.single target. -->
  <property name="test.name" value="ptolemy.actor.lib.test.junit.JUnitTclTest" />

  <!-- The timeout in seconds for findbugs.
       See also the timeout= values in ptolemy/util/test/junit/*.java. -->
  <property name="timeout" value="2400000" />

  <!-- The timeout in seconds for short running tests.
       See also the timeout= values in ptolemy/util/test/junit/*.java.
       Originally, 2400000.
       10000 was too short for ptolemy.cg.kernel.generic.program.procedural.java.modular.test.junit -->
  <property name="timeout.short" value="1000000" />

  <!-- The timeout in seconds for long running junit tests.
       See also the timeout= values in ptolemy/util/test/junit/*.java. -->
  <property name="timeout.long" value="4000000" />

  <!-- The timeout in seconds for longest running junit tests.
       See also the timeout= values in ptolemy/util/test/junit/*.java. -->
  <property name="timeout.longest" value="14000000" />


  <!-- Ant paths to optional jar files set by the configure script. -->
  <path id="ptII.classpath.optional">
    <pathelement location="${basedir}" />
    <pathelement location="lib/bsh-2.0b4.jar" />
    <pathelement location="lib/ptCal.jar" />
    <pathelement location="lib/java_cup.jar" />
    <pathelement location="lib/saxon8.jar" />
    <pathelement location="lib/saxon8-dom.jar" />
    <pathelement location="lib/chic.jar" />
    <pathelement location="lib/guava.jar" />
    <pathelement location="lib/jetty-all-8.1.5-v20120716.jar" />
    <pathelement location="lib/javax.servlet-api-3.0.1.jar" />
    <pathelement location="lib/jna.jar" />
    <pathelement location="lib/junit-4.8.2.jar" />
    <pathelement location="lib/JUnitParams-0.3.0.jar"/>
    <pathelement location="lib/javax.mail.jar" />
    <pathelement location="lib/jcerti.jar" />
    <pathelement location="lib/js.jar" />
    <pathelement location="lib/jython.jar" />
    <pathelement location="lib/kieler.jar" />
    <pathelement location="lib/org.apache.oltu.oauth2.client-1.0.1-SNAPSHOT.jar" />
    <pathelement location="lib/org.apache.oltu.oauth2.common-1.0.1-SNAPSHOT.jar" />
    <pathelement location="lib/ptcolt.jar" />
    <pathelement location="lib/ptjacl.jar" />
    <pathelement location="lib/mapss.jar" />
    <pathelement location="lib/oscP5.jar" />
    <pathelement location="lib/smack.jar" />
    <pathelement location="lib/smackx.jar" />
    <pathelement location="lib/socketio.jar" />
    <pathelement location="lib/sootclasses.jar" />
    <pathelement location="ptolemy/distributed/jini/jar/jini-core.jar" />
    <pathelement location="ptolemy/distributed/jini/jar/jini-ext.jar" />
    <pathelement location="ptolemy/distributed/jini/jar/sun-util.jar" />
    <pathelement location="ptolemy/domains/ptinyos/lib/jdom.jar" />
    <pathelement location="ptolemy/domains/ptinyos/lib/nesc.jar" />
    <pathelement location="ptolemy/actor/ptalon/antlr/antlr.jar" />
    <pathelement location="lib/PDFRenderer.jar" />
    <pathelement location="ptserver/lib/hessian-4.0.7.jar" />
    <pathelement location="ptserver/lib/jetty-all-8.1.2.v20120308.jar" />
    <pathelement location="ptserver/lib/servlet-api-2.5.jar" />
    <pathelement location="ptserver/lib/wmqtt.jar" />
    <pathelement location="lib/org-netbeans-api-visual.jar" />
    <pathelement location="lib/org-openide-util-lookup.jar" />
    <pathelement location="lib/org-openide-util.jar" />
    <pathelement location="lib/org.eclipse.paho.client.mqttv3.jar" />
    <pathelement location="lib/netty-all-4.0.21.Final.jar" />
    <pathelement location="lib/vertx-core-2.1.5.jar" />
    <pathelement location="lib/vertx-hazelcast-2.1.5.jar" />
    <pathelement location="lib/vertx-platform-2.1.5.jar" />
    <pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
  </path>

  <!-- The optional jar files as a property, used in subant. -->
  <pathconvert property="ptII.classpath.optional.property" refid="ptII.classpath.optional"/>

  <!-- Ant paths. Alphabetize, please -->
  <!-- Path for Cobertura, used by code coverage. -->

  <path id="cobertura.classpath">
    <fileset dir="${cobertura.dir}">
      <include name="@COBERTURA_JAR@" />
      <include name="lib/*.jar"/>
    </fileset>
  </path>

  <path id="ptII.classpath">
    <pathelement location="${env.HOME}/.ptolemyII" />
    <!-- Java 1.6 and later: * in the classpath matches *.jar files -->
    <pathelement location="${env.HOME}/.ptolemyII/*" />
    <path refid="ptII.classpath.optional"/>
    <!-- Include ptolemy/moml/test so that ptolemy/moml/test/MoMLParserNoPackage.tcl passes -->
    <pathelement location="ptolemy/moml/test"/>
  </path>

  <!-- Ant patternsets. Alphabetize, please -->
  <!-- ptII.excludes should match ptII/.classpath.default -->
  <patternset id="ptII.excludes">
    <exclude name="**/CVS/" />
    <exclude name="**/adm/" />
    <exclude name="**/codeDoc/" />
    <exclude name="**/cobertura.ser" />
    <exclude name="**/makefile" />
    <exclude name="**/.*" />
    <exclude name="**/*.bat" />
    <exclude name="**/*.class" />
    <exclude name="**/*.html" />
    <exclude name="**/*.in" />
    <exclude name="**/*.png" />
    <exclude name="**/*.tcl" />
    <exclude name="**/*.xml" />
    <exclude name="bin/" />
    <exclude name="config/" />
    <exclude name="contrib/" />
    <exclude name="diva/util/java2d/svg/" />
    <exclude name="doc/coding/templates/" />
    <exclude name="doc/doclets/" />
    <exclude name="jni/test/jni/meaningOfLife/" />
    <exclude name="jni/test/jni/testDeux/" />
    <exclude name="jni/test/jni/testTrois/" />
    <exclude name="lib/" />
    <exclude name="mk/" />
    <exclude name="org/ptolemy/fmi/" />
    <exclude name="org/ptolemy/terraswarm/gdp" />
    <exclude name="ptdb/" />
    <exclude name="pt-modules/" />
    <exclude name="ptolemy/actor/corba/" />
    <exclude name="ptolemy/actor/lib/embeddedJava/" />
    <exclude name="ptolemy/actor/lib/excel/" />
    <exclude name="ptolemy/actor/lib/fmi/" />
    <exclude name="ptolemy/actor/lib/io/comm/" />
    <exclude name="ptolemy/actor/lib/jai/" />
    <exclude name="ptolemy/actor/lib/jmf/" />
    <exclude name="ptolemy/actor/lib/jni/" />
    <exclude name="ptolemy/actor/lib/jopio/" />
    <exclude name="ptolemy/actor/lib/joystick/" />
    <exclude name="ptolemy/actor/lib/jxta/" />
    <exclude name="ptolemy/actor/lib/mail/" />
    <exclude name="ptolemy/actor/lib/opencv/" />
    <exclude name="ptolemy/actor/lib/reactable/" />
    <exclude name="ptolemy/actor/lib/vertx/" />
    <exclude name="ptolemy/actor/lib/x10/" />
    <exclude name="ptolemy/apps/" />
    <exclude name="ptolemy/backtrack/eclipse/" />
    <exclude name="ptolemy/backtrack/test/" />
    <exclude name="ptolemy/calltrop/" />
    <exclude name="ptolemy/chic/" />
    <exclude name="ptolemy/copernicus/" />
    <exclude name="ptolemy/copernicus/kernel/fragment/" />
    <exclude name="ptolemy/copernicus/shallow/cg/"/>
    <exclude name="ptolemy/distributed/" />
    <exclude name="ptolemy/domains/ct/demo/Saber/" />
    <exclude name="ptolemy/domains/giotto/" />
    <exclude name="ptolemy/domains/gr/" />
    <exclude name="ptolemy/domains/gr/lib/experimental/" />
    <exclude name="ptolemy/domains/gr/lib/quicktime/" />
    <exclude name="ptolemy/domains/openmodelica/kernel/" />
    <exclude name="ptolemy/domains/metroII/gui/" />
    <exclude name="ptolemy/domains/metroII/kernel/" />
    <exclude name="ptolemy/domains/metroII/kernel/util/ProtoBuf/" />
    <exclude name="ptolemy/domains/pdf/" />
    <exclude name="ptolemy/domains/space/" />
    <exclude name="ptolemy/matlab/" />
    <exclude name="ptolemy/moml/jxta/" />
    <exclude name="ptolemy/plot/adm/"/>
    <exclude name="ptolemy/plot/servlet/" />
    <exclude name="ptolemy/vergil/basic/export/itextpdf/" />
    <exclude name="ptolemy/vergil/basic/export/html/" />
    <exclude name="ptolemy/vergil/basic/imprt/fmu/" />
    <exclude name="ptolemy/vergil/basic/imprt/g4ltl/" />
    <exclude name="ptserver/" />
    <exclude name="reports/" />
    <exclude name="signed/" />
    <exclude name="src/" />
    <exclude name="target/" />
    <exclude name="tmp/" />
    <exclude name="thales/" />
    <exclude name="vendors/" />
  </patternset>

  <!-- There are several categories of test, 32-bit tests, regular tests, long tests
       and longest tests.  We have excludes for each category. -->

  <!-- Tests that we want to exclude because they don't work or are called by AllTests. -->
  <patternset id="test.32bit.excludes">
    <exclude name="**/junit/JUnitAuto32Test.*" />
  </patternset>

  <!-- Tests that we want to exclude because they don't work or are called by AllTests. -->
  <patternset id="test.excludes">
    <exclude name="**/adm/test/junit/JUnitTclTest*" />
    <exclude name="**/HTMLAboutJUnitTest.*" />
    <exclude name="**/javasound/test/junit/JUnitTclTest.*" />
    <exclude name="**/KielerJUnitTest.*" />
    <exclude name="**/ptolemy/util/test/junit/AutoCGTests.*" />
    <exclude name="**/ptolemy/util/test/junit/AutoCGKnownFailedTests.*" />
    <exclude name="**/ptolemy/util/test/junit/ModelKnownFailedTests.*" />
    <exclude name="**/ptolemy/util/test/junit/ModelTests.*" />
    <exclude name="**/lbnl/actor/lib/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptserver/test/junit/FileDownloadTest.*" />
    <exclude name="**/ptserver/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptserver/test/junit/RESTGetHandlerTest.*" />
    <exclude name="**/ptserver/test/junit/RemoteModelTest.*" />
    <exclude name="**/ptserver/test/junit/ServerTest.*" />
    <exclude name="**/ptserver/test/junit/ServletTest.*" />
    <exclude name="**/ptserver/test/junit/TokenParserTest.*" />
    <exclude name="**/ptserver/test/junit/TypeParserTest.*" />
  </patternset>

  <!-- Include tests that take a long time to run.
       These tests should be excluded by test.long.excludes -->
  <patternset id="test.long.includes">
    <include name="**/JUnitCGJavaTest.*" />
    <include name="**/ptolemy/actor/lib/test/junit/JUnitTclTest.*" />
    <include name="**/ptolemy/configs/test/junit/JUnitTclTest.*" />
    <include name="**/ptolemy/domains/continuous/test/junit/JUnitTclTest.*" />
    <include name="**/ptolemy/domains/de/test/junit/JUnitTclTest*" />
    <include name="**/ptolemy/domains/ptides/test/junit/JUnitTclTest.*" />
    <include name="**/ptolemy/plot/test/junit/JUnitTclTest*" />
  </patternset>

  <!-- Exclude long running tests. -->
  <patternset id="test.long.excludes">
    <exclude name="**/JUnitCGJavaTest.*" />
    <exclude name="**/ptolemy/actor/lib/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptolemy/configs/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptolemy/domains/continuous/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptolemy/domains/de/test/junit/JUnitTclTest*" />
    <exclude name="**/ptolemy/domains/ptides/test/junit/JUnitTclTest.*" />
    <exclude name="**/ptolemy/plot/test/junit/JUnitTclTest*" />
  </patternset>

  <!-- Include tests that take longest time to run.
       These tests should be excluded by test.longest.excludes -->
  <patternset id="test.longest.includes">
    <include name="**/ptolemy/vergil/basic/export/test/junit/ExportModelJUnitTest.*" />
  </patternset>

  <!-- Exclude longest running tests. -->
  <patternset id="test.longest.excludes">
    <exclude name="**/ptolemy/vergil/basic/export/test/junit/ExportModelJUnitTest.*" />
  </patternset>


  <!-- Ant targets. Alphabetize and add a description, please.  -->

  <target name="build"
	  depends="build-message, build-subprojects, build-project"
	  description="Build Ptolemy II by compiling the .java files.  This is the default ant target.  Run 'ant build-all' to build everything."/>

  <target name="build-all"
	  depends="build, build-lbnl, build-bin"
	  description="Build Ptolemy II by compiling the .java files, the .c files in $PTII/lbnl and the $PTII/bin scripts."/>

  <target name="-check-ptII-mk-file" unless="ptII.mk..exists">
    <available property="ptII.mk.exists" file="mk/ptII.mk"/>
  </target>

  <target name="build-bin"
	  depends="-check-ptII-mk-file, build-bin-not"
	  description="Run make in $PTII/bin, which creates scripts like $PTII/bin/vergil."
	  if="${ptII.mk.exists}">
      <exec dir="${basedir}/bin" executable="make">
      </exec>
  </target>

  <target name="build-bin-not"
	  unless="${ptII.mk.exists}">
      <echo>
	$PTII/mk/ptII.mk does not exist, perhaps (cd $PTII; ./configure) has not been run?
	Skipping running make in $PTII/bin, which creates scripts like $PTII/bin/vergil.
	This is only an issue if you want to invoke "$PTII/bin/vergil" instead of "ant vergil".
	However, $PTII/bin does include other scripts that may be of use.
      </echo>
  </target>

  <target name="build-message">
    <echo>Use ant -p to see other targets. JAVA_HOME=${env.JAVA_HOME}
tools.jar is necessary for compilation of doc/doclets/.
If compilation fails, try setting JAVA_HOME to the location of the JDK.
For example:
  [bldmastr@sisyphus ptII]$ which java
  /usr/bin/java
  [bldmastr@sisyphus ptII]$ ls -l /usr/bin/java
  lrwxrwxrwx 1 root root 26 Jul 31 10:12 /usr/bin/java -> /usr/java/default/bin/java
  [bldmastr@sisyphus ptII]$ export JAVA_HOME=/usr/java/default
    </echo>
  </target>

  <target name="build-lbnl"
	  description="Run make in $PTII/lbnl, which creates executables like cclient."
	  depends="-check-ptII-mk-file, build-lbnl-not"
	  if="${ptII.mk.exists}">
      <echo>
        Running make in $PTII/lbnl, which creates executables like cclient.
	Typically, this is run after build-project so that the .class files are created.
      </echo>
      <exec dir="${basedir}/lbnl" executable="make">
      </exec>
  </target>

  <target name="build-lbnl-not"
	  unless="${ptII.mk.exists}">
      <echo>
	$PTII/mk/ptII.mk does not exist, perhaps (cd $PTII; ./configure) has not been run?
	Skipping running make in $PTII/lbnl, which creates executables like cclient.
	This is only an issue if you are trying to build
	the Building Controls Virtual Test Bed (BCVTB).
      </echo>
  </target>

  <target name="build-subprojects"
	  depends="build-pt-modules"
	  description="Build subprojects."/>

  <target name="build-project">
    <echo message="${ant.project.name}: ${ant.file}" />
    <javac debug="true"
	   debuglevel="${debuglevel}"
	   destdir="."
	   includeAntRuntime="false"
	   fork="true"
	   memoryinitialsize="256m"
	   memorymaximumsize="${java.maxmemory}"
	   source="${source}"
	   target="${target}">
      <src path="${basedir}" />
      <patternset refid="ptII.excludes" />
      <classpath refid="ptII.classpath" />
    </javac>
  </target>

  <target name="build-pt-modules"
	  description="Build $PTII/pt-modules, a subset of Ptolemy II.">
    <ant antfile="build.xml"
	 dir="pt-modules/build"
	 target="build-all"/>
  </target>

  <target name="checkstyle" depends="initReports"
	  description="Run checkstyle and find common code style problems." >
    <echo>To avoid an 'OutOfMemoryError' exception, under bash, try 'export ANT_OPTS=-Xmx1024m'</echo>
    <taskdef resource="checkstyletask.properties" classpath="${basedir}/vendors/checkstyle-5.7/checkstyle-5.7-all.jar" />
    <checkstyle config="${basedir}/ptserver/checkstyle-ptserver.xml" failOnViolation="false">
      <fileset defaultexcludes="yes"
	       dir="${basedir}">
	<patternset refid="ptII.excludes" />
      </fileset>
      <formatter type="${checkstyle.formatter}" toFile="${ptII.reports}/checkstyle_errors.${checkstyle.formatter}" />
    </checkstyle>
    <!-- <xslt in="${ptII.reports}/checkstyle_errors.xml" out="${ptII.reports}/checkstyle_report.html" style="${basedir}/ptserver/checkstyle-simple.xsl"/> -->
  </target>

  <target name="clean"
	  description="Remove all the class files.">
    <echo>
      Removing .class files.  Use 'ant cleanall' to remove files in reports/ and codeDoc/.
      Use 'ant jars.clean' to remove the jar files created by 'ant jars'.      
    </echo>
    <delete quiet="true" verbose="no" includeemptydirs="true">
      <fileset dir="${basedir}"
	       includes="**/*.class" />
      <fileset dir="${basedir}"
	       includes="*_l4j.xml" />
    </delete>
  </target>

  <target depends="clean" name="cleanall" 
	  description="Remove all the class files, the ${ptII.reports} directory and any codeDoc directories.">
    <delete quiet="true" verbose="no" includeemptydirs="true">
      <fileset dir="${basedir}" includes="reports/**" defaultexcludes="false"/>
      <fileset dir="${basedir}" includes="**/codeDoc*/**" defaultexcludes="false"/>
    </delete>
  </target>

  <target name="doccheck"
	  depends="initReports"
	  description="Run Doccheck (http://java.sun.com/j2se/javadoc/doccheck/) to detect JavaDoc bugs." >
    <javadoc destdir="${ptII.reports}/doccheck"
	     packagenames="${javadoc.packagenames}"
	     excludepackagenames="${javadoc.excludepackagenames}"
	     maxmemory="${java.maxmemory}"
	     useexternalfile="true">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
      <doclet name="com.sun.tools.doclets.doccheck.DocCheck" path="vendors/sun/doccheck1.2b2/doccheck.jar" />
      <packageset dir="${basedir}" defaultexcludes="yes">
	<patternset refid="ptII.excludes" />
	<exclude name="org/ptolemy/websensor/controller/" />
	<exclude name="ptolemy/apps/websensor/src/main/java/org/ptolemy/websensor/controller/" />
      </packageset>	
    </javadoc>
  </target>

  <!-- findbugs.  See http://findbugs.sourceforge.net/manual/anttask.html -->
  <target name="findbugs"
	  depends="build, initReports"
	  description="Run FindBugs (http://findbugs.sourceforge.net/)">
    <echo>
      We use a patched version of findbugs that supports the -nested:false command line argument,
      see https://sourceforge.net/p/findbugs/feature-requests/295/

      Install the patched FindBugs in ptII/vendors/ and update the findbugs.home property above.

      Below are the steps necessary to patch 3.0.0 from 2013-12-04

      cd $PTII/vendors
      unzip ~/Downloads/findbugs-3.0.0-dev-20131204-e3cbbd5-source.zip
      mv findbugs-3.0.0-dev-20131204-e3cbbd5 findbugs-3.0.0-dev
      cd findbugs-3.0.0-dev/src/antTask/edu/umd/cs/findbugs/anttask/
      wget --no-check-certificate https://sourceforge.net/p/findbugs/feature-requests/295/attachment/FindBugsAntTaskNested.patch
      cat  FindBugsAntTaskNested.patch | patch -n -p0 
      # The file to patch is FindBugsTask.java

      # Build the changed file:
      cd ../../../../../../..
      ant

      # Determine where the findbugs-ant.jar file is in your ant directory.  
      # Find the ant directory with "which ant" and copy the findbugs-ant.jar file:
      sudo cp lib/findbugs-ant.jar /usr/share/ant/lib/

      FindBugs takes 4-5 minutes to run . . .
    </echo>
    <taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" />
    <findbugs 
       excludefilter="${basedir}/doc/findbugs-exclude.xml"
       home="${findbugs.home}"
       includefilter="${basedir}/doc/findbugs-include.xml"
       jvmargs="-Xms256m -Xmx2000m"
       nested="false"
       output="xml"
       outputFile="${ptII.reports}/ptII-findbugs.xml"
       timeout="${timeout}"
       >
      <auxclasspath refid="ptII.classpath" />
      <class location="${basedir}" />
      <sourcePath path="${basedir}" />
    </findbugs>
  </target>

  <target name="initReports">
    <mkdir dir="${junit.output.dir}" />
    <!-- doccheck and ojdcheck go into separate directories so that we can use
	 the Hudson HTML Publisher plugin. -->
    <mkdir dir="${ptII.reports}/doccheck" />
    <mkdir dir="${ptII.reports}/ojdcheck" />
  </target>

  <target name="installers" depends="initReports,build,jars"
	  description="Build installers by running a test, output goes to stdout." >
    <echo>
     Target to be invoked by users that create installers in the adm/gen-X.Y subdirectory.
     This target sends its output to stdout.  The test.installers target sends its output to repo
    </echo>
    <!-- printsummary takes one of One of on, off, and withOutAndErr.  Off is the default-->
    <junit fork="yes"
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="off"
	   showoutput="yes"
	   timeout="${timeout.longest}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <formatter type="${junit.formatter}" usefile="false"/>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <!-- ptolemy.ptII.batchMode is checked in MessageHandler -->
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <test  name="adm.test.junit.JUnitTclTest" />
    </junit>
  </target>

  <target name="jars"
	  depends="build-pt-modules"
	  description="Create jar files." >
    <subant antfile="jars.xml"
	    buildpath="${basedir}"
	    target="jars" />
  </target>

  <target name="jars.clean"
	  description="Remove all the jar files created by 'ant jars'." >
    <subant antfile="jars.xml"
	    buildpath="${basedir}"
	    target="jars.clean" />
  </target>

  <target name="jars.vergil"
	  depends="build-pt-modules"
	  description="Run vergil using jar files." >
    <subant antfile="jars.xml"
	    buildpath="${basedir}"
	    target="jars.vergil">
      <property name="ptII.classpath.optional.property" value="${ptII.classpath.optional.property}"/>
    </subant>
  </target>

  <target name="javadoc"
	  depends="javadoc.actorIndex, javadoc.base"
	  description="Generate javadoc including actor documentation and actor/demo index." /> 

  <target name="javadoc.actor"
	  depends="build, javadoc.doclets">
    <echo>
     Generate javadoc .xml files used for actor documentation.
     Generate doc/codeDoc/allNamedObjs.txt for use by javadoc.actorIndex
     For details, see $PTII/ptolemy/vergil/basic/docViewerHelp.htm
    </echo>
    <javadoc destdir="doc/codeDoc"
	     packagenames="${javadoc.packagenames}"
	     excludepackagenames="${javadoc.excludepackagenames}"
	     maxmemory="${java.maxmemory}"
	     sourcepath="${basedir}" >
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
      <doclet name="doc.doclets.PtDoclet" path="${basedir}" />
    </javadoc>
  </target>

  <target name="javadoc.actorIndex"
	  depends="javadoc.actor">
    <echo>
     Generate actor/demonstration index files.
     Read the doc/codeDoc/allNamedObjs.txt file created by javadoc.actor.
     Create the actor index.
     For details, see $PTII/ptolemy/vergil/basic/docViewerHelp.htm
    </echo>
    <java classname="ptolemy.moml.filter.ActorIndex"
	  fork="true"
	  maxmemory="${java.maxmemory}"
	  >
      <arg line="doc/codeDoc/allNamedObjs.txt ptolemy/configs/doc/models.txt doc/codeDoc"/>
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
    </java>
  </target>

  <target name="javadoc.base"
	  depends="javadoc.doclets">
    <echo>Generate javadoc without building the actor documentation and the actor/demonstration index</echo>
    <javadoc destdir="doc/codeDoc"
	     additionalparam="-tag Pt.AcceptedRating -tag Pt.ProposedRating -tag status:a:Status"
	     packagenames="${javadoc.packagenames}"
	     excludepackagenames="${javadoc.excludepackagenames}"
	     maxmemory="${java.maxmemory}"
	     sourcepath="${basedir}" >
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
      <taglet name="doc.doclets.RatingTaglet"
	      path="${basedir}" />
    </javadoc>
  </target>

  <target name="javadoc.doclets">
    <echo>Compile doc/doclets.
tools.jar is necessary for compilation of doc/doclets/.
If compilation fails, try setting JAVA_HOME to the location of the JDK.
For example:
  [bldmastr@sisyphus ptII]$ which java
  /usr/bin/java
  [bldmastr@sisyphus ptII]$ ls -l /usr/bin/java
  lrwxrwxrwx 1 root root 26 Jul 31 10:12 /usr/bin/java -> /usr/java/default/bin/java
  [bldmastr@sisyphus ptII]$ export JAVA_HOME=/usr/java/default
    </echo>
    <javac debug="true"
	   debuglevel="${debuglevel}"
	   destdir="."
	   includeAntRuntime="false"
	   fork="true"
	   memoryinitialsize="256m"
	   memorymaximumsize="${java.maxmemory}"
	   source="${source}"
	   target="${target}">
      <src path="${basedir}/doc/doclets" />
      <src path="${basedir}/ptolemy/util" />
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
    </javac>    
  </target>

  <!-- Ojdcheck
       We have a local copy at
       svn co svn+ssh://source.eecs.berkeley.edu/chess/ojdcheck 
       The primary difference is that ojdcheck handles enums -->
  <target name="ojdcheck"
	  depends="initReports"
	  description="Ojdcheck - An updated version of DocCheck. See http://github.com/egonw/ojdcheck">
    <javadoc additionalparam="-xhtml -file ${ptII.reports}/ojdcheck/ojdcheck.htm"
	     packagenames="${javadoc.packagenames}"
	     excludepackagenames="${javadoc.excludepackagenames}"
	     maxmemory="${java.maxmemory}"
	     sourcepath="${basedir}" >
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
      </classpath>
      <doclet name="com.github.ojdcheck.OpenJavaDocCheck" path="lib/ojdcheck.jar" />
    </javadoc>
  </target>

  <target name="reports"
	  description="Generate non-test reports about the Ptolemy II code base."
	  depends="checkstyle, doccheck, findbugs, ojdcheck" />

  <target name="resignjars"
	  description="Update the certificate of jar files in signed/**/*.jar and **/signed_*.jar.">
    <input
       message="Please enter keystore password:"
       addproperty="keypass" />
    <signjar
       alias="ptolemy" 
       keystore="${keystore}"
       lazy="false"
       storepass="${keypass}"
       >
      <path>
        <fileset dir="signed" includes="**/*.jar" />
        <fileset dir="ptolemy" includes="**/signed_*.jar" />
      </path>
    </signjar>
  </target>

  <target name="run" depends="vergil"
	  description="Invoke the Ptolemy II User Interface (alias for the vergil target)"/>

  <target name="test"
	  depends="build, test.pt-modules, test.short, test.32bit, test.long, test.longest"
	  description="Build and run the all the junit tests." />

  <target name="test.pt-modules"
	  description="Test the jars in pt-modules.">
    <ant antfile="build.xml"
	 dir="pt-modules/build"
	 inheritAll="false"
	 target="test"
	 >
      <property name="javachdir" value="ptolemy/util/test/junit/javachdir"/>
    </ant>
  </target>

  <target name="test.32bit"
	  description="Run the 32-bit JVM tests in auto32/..">
    <echo>
      ==test.32bit==
      This target runs 32-bit JVM tests from auto32/.

      Various test targets are available:
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

      test.batch = ${test.batch}
      timeout = ${timeout.short} milliseconds

    </echo>
    <!-- fork="yes" is need so that javchdir can cd to the test/ directory -->
    <!-- printsummary = on, off, and withOutAndErr. withOutAndErr prints stdout and stderr -->
    <junit fork="yes" 
	   jvm="ptolemy/util/test/junit/javachdir32"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.short}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <!-- Set filtertrace to off so that we see the junit stackframes -->
      <batchtest filtertrace="off">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Run all the tests in test.batch -->
	  <include name="**/junit/JUnitAuto32Test.*" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <formatter type="plain" usefile="off" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
    </junit>
  </target>

  <!-- Cobertura: code coverage tool -->
  <target name="test.cobertura"
	  depends="build, initReports"
	  description="Run code coverage on all the tests"
	  >
    <echo> 
      To run code coverage on just one test, use 
      ant test.cobertura.single
    </echo>
    <property name="instrumented.dir" value="${ptII.reports}/instrumented" />
    <property name="coveragereport.dir" value="${ptII.reports}/coveragereport" />

    <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

    <delete file="cobertura.ser" />
    <delete dir="${instrumented.dir}" />
    
    <cobertura-instrument todir="${instrumented.dir}">
      <fileset defaultexcludes="yes"
	       dir="${basedir}">
	<include name="org/ptolemy/**/*.class" />
	<include name="ptolemy/**/*.class" />
	<exclude name="**/test/*.class" />
	<exclude name="**/junit/*.class" />
      </fileset>
    </cobertura-instrument>


    <!-- About forkmode,
	 http://cobertura.sourceforge.net/anttaskreference.html says:

	 "For this same reason, if you're using ant 1.6.2 or higher
	 then you might want to set forkmode="once" This will cause
	 only one JVM to be started for all your JUnit tests, and will
	 reduce the overhead of Cobertura reading/writing the coverage
	 data file each time a JVM starts/stops."

	 http://ant.apache.org/manual/Tasks/junit.html says:
	 "Controls how many Java Virtual Machines get created if you want to
	 fork some tests. Possible values are "perTest" (the default),
	 "perBatch" and "once". "once" creates only a single Java VM for all
	 tests while "perTest" creates a new VM for each TestCase
	 class. "perBatch" creates a VM for each nested <batchtest> and one
	 collecting all nested <test>s. Note that only tests with the same
	 settings of filtertrace, haltonerror, haltonfailure, errorproperty and
	 failureproperty can share a VM, so even if you set forkmode to "once",
	 Ant may have to create more than a single Java VM. This attribute is
	 ignored for tests that don't get forked into a new Java VM. since Ant
	 1.6.2"

	 However, we have to use "perTest" because javachdir needs to be
	 run for each test so that we run the test from the test directory.
      -->

    <echo> Run the short tests with timeout=${timeout.short} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir"
	   maxmemory="${java.maxmemory}"
	   printsummary="withOutAndErr"
	   showoutput="no"
	   timeout="${timeout.short}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.formatter}" />
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Run all the tests in test.batch -->
	  <include name="${test.batch}" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <echo> Run the 32-bit tests with timeout=${timeout.short} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir32"
	   maxmemory="${java.maxmemory}"
	   printsummary="withOutAndErr"
	   showoutput="no"
	   timeout="${timeout.short}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.formatter}" />
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Run the 32-bit tests-->
	  <include name="**/junit/JUnitAuto32Test.*" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <echo> Run the long tests with timeout=${timeout.long} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir"
	   maxmemory="${java.maxmemory.large}"
	   printsummary="withOutAndErr"
	   showoutput="no"
	   timeout="${timeout.long}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.formatter}" />
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Include the long running tests. -->
	  <patternset refid="test.long.includes" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <echo> Run the longest tests with timeout=${timeout.longest} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir"
	   maxmemory="${java.maxmemory.large}"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.longest}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.formatter}" />
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Include the longest running tests. -->
	  <patternset refid="test.longest.includes" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	</fileset>
      </batchtest>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <jvmarg value="-Dptolemy.ptII.exportHTML.linkToJNLP=true"/>
      <jvmarg value="-Dptolemy.ptII.exportHTML.usePtWebsite=true"/>
      <jvmarg value="-XX:MaxPermSize=256m"/>
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <cobertura-report format="xml" destdir="${coveragereport.dir}" srcdir="${basedir}" />
  </target>


  <!-- Cobertura: code coverage tool.  Run the longest tests. -->
  <target name="test.cobertura.longest" depends="build, initReports">
    <echo>Run the longest tests using code coverage
    </echo>
    <property name="instrumented.dir" value="${ptII.reports}/instrumented" />
    <property name="coveragereport.dir" value="${ptII.reports}/coveragereport" />

    <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

    <delete file="cobertura.ser" />
    <delete dir="${instrumented.dir}" />
    
    <cobertura-instrument todir="${instrumented.dir}">
      <fileset defaultexcludes="yes"
	       dir="${basedir}">
	<include name="org/ptolemy/**/*.class" />
	<include name="ptolemy/**/*.class" />
	<exclude name="**/test/*.class" />
	<exclude name="**/junit/*.class" />
      </fileset>
    </cobertura-instrument>


    <!-- About forkmode,
	 http://cobertura.sourceforge.net/anttaskreference.html says:

	 "For this same reason, if you're using ant 1.6.2 or higher
	 then you might want to set forkmode="once" This will cause
	 only one JVM to be started for all your JUnit tests, and will
	 reduce the overhead of Cobertura reading/writing the coverage
	 data file each time a JVM starts/stops."

	 http://ant.apache.org/manual/Tasks/junit.html says:
	 "Controls how many Java Virtual Machines get created if you want to
	 fork some tests. Possible values are "perTest" (the default),
	 "perBatch" and "once". "once" creates only a single Java VM for all
	 tests while "perTest" creates a new VM for each TestCase
	 class. "perBatch" creates a VM for each nested <batchtest> and one
	 collecting all nested <test>s. Note that only tests with the same
	 settings of filtertrace, haltonerror, haltonfailure, errorproperty and
	 failureproperty can share a VM, so even if you set forkmode to "once",
	 Ant may have to create more than a single Java VM. This attribute is
	 ignored for tests that don't get forked into a new Java VM. since Ant
	 1.6.2"

	 However, we have to use "perTest" because javachdir needs to be
	 run for each test so that we run the test from the test directory.
      -->

    <echo> Run the longest tests with timeout=${timeout.longest} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir"
	   maxmemory="${java.maxmemory.large}"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.longest}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.formatter}" />
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Include the longest running tests. -->
	  <patternset refid="test.longest.includes" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	</fileset>
      </batchtest>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <jvmarg value="-Dptolemy.ptII.exportHTML.linkToJNLP=true"/>
      <jvmarg value="-Dptolemy.ptII.exportHTML.usePtWebsite=true"/>
      <jvmarg value="-XX:MaxPermSize=256m"/>
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <cobertura-report format="xml" destdir="${coveragereport.dir}" srcdir="${basedir}" />
  </target>


  <!-- Cobertura: code coverage tool.  Run a single test. -->
  <target name="test.cobertura.single"
	  depends="build, initReports"
	  description="Run code coverage on a single test.">
    <echo>
      ==test.corbertura.single==
      To run code coverage on a different test, use the -Dtest.name, for example:
        ant test.cobertura.single -Dtest.name=ptolemy.configs.test.junit.JUnitTclTest

      The formatter is controlled by junit.single.formatter, which defaults to plain
      Other values are brief, failure and xml.
    </echo>
    <property name="instrumented.dir" value="${ptII.reports}/instrumented" />
    <property name="coveragereport.dir" value="${ptII.reports}/coveragereport" />

    <taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

    <delete file="cobertura.ser" />
    <delete dir="${instrumented.dir}" />
    
    <cobertura-instrument todir="${instrumented.dir}">
      <fileset defaultexcludes="yes"
	       dir="${basedir}">
	<include name="org/ptolemy/**/*.class" />
	<include name="ptolemy/**/*.class" />
	<exclude name="**/test/*.class" />
	<exclude name="**/junit/*.class" />
      </fileset>
    </cobertura-instrument>


    <!-- About forkmode,
	 http://cobertura.sourceforge.net/anttaskreference.html says:

	 "For this same reason, if you're using ant 1.6.2 or higher
	 then you might want to set forkmode="once" This will cause
	 only one JVM to be started for all your JUnit tests, and will
	 reduce the overhead of Cobertura reading/writing the coverage
	 data file each time a JVM starts/stops."

	 http://ant.apache.org/manual/Tasks/junit.html says:
	 "Controls how many Java Virtual Machines get created if you want to
	 fork some tests. Possible values are "perTest" (the default),
	 "perBatch" and "once". "once" creates only a single Java VM for all
	 tests while "perTest" creates a new VM for each TestCase
	 class. "perBatch" creates a VM for each nested <batchtest> and one
	 collecting all nested <test>s. Note that only tests with the same
	 settings of filtertrace, haltonerror, haltonfailure, errorproperty and
	 failureproperty can share a VM, so even if you set forkmode to "once",
	 Ant may have to create more than a single Java VM. This attribute is
	 ignored for tests that don't get forked into a new Java VM. since Ant
	 1.6.2"

	 However, we have to use "perTest" because javachdir needs to be
	 run for each test so that we run the test from the test directory.
      -->

    <echo> Run the tests in test.name=${test.name} with timeout=${timeout.short} </echo>
    <junit fork="yes"
	   forkmode="perTest"
	   jvm="ptolemy/util/test/junit/javachdir"
	   maxmemory="${java.maxmemory}"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.short}">
      <classpath>
	<path location="${instrumented.dir}" />
	<path refid="ptII.classpath" />
	<path refid="cobertura.classpath" />
      </classpath>
      <formatter type="${junit.single.formatter}" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <test  name="${test.name}" />
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser" />
    </junit>

    <cobertura-report format="xml" destdir="${coveragereport.dir}" srcdir="${basedir}" />
  </target>


  <target name="test.installers" depends="initReports,build,jars"
	  description="Build installers by running a test, output goes to reports/junit." >
    <echo>
     Target to be invoked by the nightly build that create installers in the adm/gen-X.Y subdirectory.
     This test generates .xml files in reports/junit.  The installers target sends its output to stdout.
    </echo>
    <!-- printsummary takes one of One of on, off, and withOutAndErr.  Off is the default-->
    <junit fork="yes"
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.longest}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <formatter type="${junit.formatter}" usefile="true"/>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <test  name="adm.test.junit.JUnitTclTest" 
	     todir="${junit.output.dir}"
	     />
    </junit>
  </target>

  <target name="test.long"
	  description="Run the long-running junit tests in a directory or directories.">
    <!-- fork="yes" is need so that javchdir can cd to the test/ directory -->
    <!-- printsummary = on, off, and withOutAndErr. withOutAndErr prints stdout and stderr -->
    <echo>
      ==test.long==
      This target runs test specified by a file name and generates
      human readable output to stdout.

      The default is to run all the fairly long-running tests.

      Various test targets are available:
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (~30 min., called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

      timeout = ${timeout.long} milliseconds

    </echo>
    <junit fork="yes" 
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.long}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <!-- Set filtertrace to off so that we see the junit stackframes -->
      <batchtest filtertrace="off">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Include the long running tests. -->
	  <patternset refid="test.long.includes" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <formatter type="plain" usefile="off" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
    </junit>
  </target>


  <target name="test.longest"
	  description="Run the longest-running junit tests in a directory or directories.">
    <!-- fork="yes" is need so that javchdir can cd to the test/ directory -->
    <!-- printsummary = on, off, and withOutAndErr. withOutAndErr prints stdout and stderr -->
    <echo>
      ==test.longest==
      This target runs test specified by a file name and generates
      human readable output to stdout.

      Various test targets are available:
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (~30 min., called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

      timeout = ${timeout.longest} milliseconds

    </echo>
    <junit fork="yes" 
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.longest}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <!-- Set filtertrace to off so that we see the junit stackframes -->
      <batchtest filtertrace="off">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Include the longest running tests. -->
	  <patternset refid="test.longest.includes" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	</fileset>
      </batchtest>
      <formatter type="plain" usefile="off" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <jvmarg value="-XX:MaxPermSize=256m"/>
    </junit>
  </target>

  <target name="test.report" depends="build, initReports"
	  description="Run the all the junit tests by path (**/junit/*.java), results in $PTII/reports.">
    <echo>
      ==test.report==
      This target runs all the tests (short, long, longest) and generates
      ${junit.formatter} output in ${junit.output.dir}.
 
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (~30 min., called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

      test.batch = ${test.batch}
      timeout.long = ${timeout.long}
    </echo>
    <junit fork="yes"
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.long}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <batchtest todir="${junit.output.dir}">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <include name="${test.batch}" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	</fileset>
      </batchtest>
      <formatter type="${junit.formatter}" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
    </junit>
  </target>

  <target name="test.short"
	  description="Run the short-running junit tests in a directory or directories.">
    <echo>
      ==test.short==
      This target runs test specified by a file name and generates 
      human readable output to stdout.

      The default is to run all the fairly short-running tests.
      On a fast machine, these tests take around 30 minutes.

      To run different tests, use -Dtest.batch, for example:
         ant test.short -Dtest.batch=ptolemy/domains/continuous/**/junit/*.java
      
      Various test targets are available:
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

      test.batch = ${test.batch}
      timeout = ${timeout.short} milliseconds

    </echo>
    <!-- fork="yes" is need so that javchdir can cd to the test/ directory -->
    <!-- printsummary = on, off, and withOutAndErr. withOutAndErr prints stdout and stderr -->
    <junit fork="yes" 
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.short}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <!-- Set filtertrace to off so that we see the junit stackframes -->
      <batchtest filtertrace="off">
	<fileset defaultexcludes="yes"
		 dir="${basedir}">
	  <!-- Run all the tests in test.batch -->
	  <include name="${test.batch}" />
	  <patternset refid="ptII.excludes" />
	  <patternset refid="test.32bit.excludes" />
	  <patternset refid="test.excludes" />
	  <!-- Exclude the long running tests -->
	  <patternset refid="test.long.excludes" />
	  <!-- Exclude the longest running tests -->
	  <patternset refid="test.longest.excludes" />
	</fileset>
      </batchtest>
      <formatter type="plain" usefile="off" />
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
    </junit>
  </target>

  <target name="test.single" depends="initReports"
	  description="Run a single JUnit test by classname (ptolemy.actor.lib.test.junit.JUnitTclTest).">
    <echo>
      ==test.single==
      Run a single JUnit test by classname (ptolemy.actor.lib.test.junit.JUnitTclTest).

      To run a different test, use -Dtest.name=ptolemy...JUnitTclTest   and
         -Djunit.single.formatter=xml|brief|plain|failure (default is plain)
      For example:
      * Run all the tests in actor/lib/test
          ant test.single
      * Run all the tests in kernel/test
          ant test.single -Dtest.name=ptolemy.kernel.test.junit.JUnitTclTest
      Various other test targets are available:
       test - builds and runs test.short, test.long and test.longest
       test.32bit - runs the 32-bit JVM tests in auto32/
       test.cobertura - run tests using code coverage
       test.long - runs tests that are fairly long (called by the test target)
       test.longest - runs tests that are longest (called by the test target)
       test.report - runs batch of tests specified by a path with wildcards (output=files)
       test.short - runs tests that are fairly fast (called by the test target)
       test.single target runs single test specified by its class name (output=stdout)

    </echo>
    <!-- printsummary takes one of One of on, off, and withOutAndErr.  Off is the default-->
    <junit fork="yes"
	   jvm="ptolemy/util/test/junit/javachdir"
	   printsummary="withOutAndErr"
	   showoutput="yes"
	   timeout="${timeout.short}">
      <classpath>
	<path refid="ptII.classpath" />
	<pathelement location="lib/JUnitParams-0.3.0.jar"/>
      </classpath>
      <formatter type="${junit.single.formatter}" usefile="false"/>
      <jvmarg value="-Dptolemy.ptII.dir=${basedir}" />
      <jvmarg value="-Dptolemy.ptII.batchMode=true" />
      <test  name="${test.name}" />
    </junit>
  </target>

  <target name="update"
	  description="Update the tree from the SVN repository." >
    <exec executable="svn">
      <arg value="update"/>
    </exec>
  </target>

  <target name="vergil" depends="build-project"
	  description="Invoke the Ptolemy II User Interface.  To run a model, use ant vergil -Dmodel=model.xml"
	  >
    <java classname="ptolemy.vergil.VergilApplication"
	  fork="true">
      <classpath>
	<pathelement location="/Users/cxh/ptII" />
	<path refid="ptII.classpath"/>
      </classpath>
      <jvmarg value="-Xmx${java.maxmemory}"/>
      <arg line="${model}"/>
    </java>
  </target>

</project>
